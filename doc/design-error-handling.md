## KOA RTI Error Handling

The challenge: With realtime ingestion of files, we need to know immediately if there is a problem.  However, if the nature of the problem is repeating itself per file, we do not want to get our inbox filled with potentially thousands of emails.  

This is the case for the KOA Monitor and DEP processing.  Where as the monitor runs continuously, DEP can be spawned on an individual file or group of files.  So the problem is handled slightly different.



## KOA Monitor

The KOA Monitor is designed to be straight-forward and not concerned with the intricacies of archive processing.  Its tasks are:

- Monitor instruments for new images via KTL services.
- Queue them up for DEP processing by inserting the filepath as a new record into a database with status='QUEUED'.  
- Monitor the queue and spawns a DEP process for each record.

Errors:
All monitor errors of any errcode type are handle via a single error handling function  This function checks the last admin error email time for that error code and only sends another email if some amount of time has passed (1 hour currently).  The time check is by error type so one type of error would not hold up reporting of another type.  The types of errors are:

- DATABASE_ERROR: Unable to execute query.
- KTL_START_ERROR: Unable to start KTL monitor (retries every 60 seconds)
- KTL_READ_ERROR: Unable to read KTL keywords to form filepath.
- PROCESS_ERROR: Unable to start DEP process.
- MONITOR_ERROR: Any other uncaught error in monitor code.

Monitor logging:
- A log file is created per instrument monitored at: /koadata/[INSTR]/koa_monitor_[INSTR].log
- The monitor logs a hello message every 5 minutes just to say it is alive.

Administration:
Notification of errors is done via email to dev admins.  Details of the error should be investigated in the logs.  Admin can then decide what action to take, whether that be code fixes and/or restart of monitor.  If the nature of the error potentially means that we missed notifications, admin will need to query keyword history database to recover and process missing files.  If a DB record was inserted, admin can use archive.py to process unprocessed files by status=QUEUED.



## DEP 

DEP can be run on an individual datafile (via monitor) or group of datafiles (via reprocessing).  And, DEP will always have a handle to a database record for the file it is processing (though there are a few edge cases).  So, it makes sense to use the dep_status table to consolidate error logging.  Similar to the monitor, errors will only be sent at an interval so as to not clog inboxes.  Except now the last error check will be done against the dep_status table and done per instrument.  This will be done via a stand-alone script that can be run at regular intervals and/or called by DEP itself each time it logs a record with status=ERROR.  See "DEP error reporting script" below.

All DEP runs start with the Archive class which just has these functions:
- Handle different command line options for calling DEP (single, by group, reprocess, etc)
- Call DEP for each datafile
- Call DEP error reporting script if processing fails.

The DEP class does all the heavy-lifting.  At a high level, DEP takes as an input either a filepath (which will create a new DB record) or database ID (which is queried for the filepath).  It then runs all the code that produces the archive output files, updates the DB record and transfers to IPAC.  If anything critical goes wrong, nominal processing is aborted and a function handle_dep_error is called that updates the database record with status=ERROR.

If a file is invalid for archiving (DUPLICATE_KOAID, EMPTY_FILE, UNREADABLE, etc), its status is set to 'INVALID' and it is copied to anc/udf/.  Invalid files do not trigger an error notification, but they can be reported on (see DEP daily report below).

DEP logging:
- A log file is created per UTC processing date at: /koadata/[INSTR]/koa_dep_[INSTR]_[DATEUTC].log
- Extensive logging is generated by DEP
- NOTE: Planning on changing this to a log file per KOAID so that parallel DEP processes would not intertwine in log file.

Administration:
Notification of errors is done via email to dev admins.  Details of the error should be investigated in the logs.  Admin can then decide what action to take whether that be code fixes and/or reprocessing of records.



## DEP error reporting script

Script is independent of DEP and will be run on a cron every hour and can be called directly from DEP whenever DEP updates a record with status=ERROR.

Script will query a dep_error_notify table for last error email_time:
	select email_time from dep_error_notify where instrument='{instr}'

If email_time is NULL or more than X minutes ago, script will see if there are any ERROR records:
	select count(*) from dep_status where instrument='{instr}' and status='ERROR' 

Script will send an email summary that says how many outstanding errors there are of each status_code type (above query could be altered to get the counts as well).  Example contents:
	HIRES DEP has the following errors:
	  34 FILE_IO 
	  62 FITS_NOT_FOUND

Script will update email_time:

	update email_time set email_time=NOW() where instrument='{instr}'



# Daily DEP report

An independent script that runs each morning that sends out a daily report on all instrument processing for the last 24 hours.  This would be a spinoff of the current check_koa_processing.py but geared towards RTI.  This report could include ERROR/INVALID status stats as well.



# Questions:
- Should we create an error table for the monitor and have an independent script that checks on it regularly like we do for DEP?
- How will we handle DEP "errors" that are not critical which should not hold up archiving (ie set_koaimtyp fails)?  Could we still use status_code but not set status='ERROR' so they can be searched/reported on separately?
- How will we deal with a database failure which would break parts of this error reporting system?  Presumably this would be covered by the error reporting/email in monitor.py which does not rely on the database for error reporting.
- It is not clear yet if we should notify koadmin right away of invalid datafiles and/or report on them.  I am leaning towards yes but maybe just in a daily KOA summary report.